---
- name: create iSCSI target {{ target.name }}
  targetcli_iscsi:
    wwn: "{{ iscsi_base_wwn }}:{{ target.name }}"
  notify:
    - save targetcli configuration

- name: define ACLs for iSCSI target {{ target.name }}
  targetcli_iscsi_acl:
    wwn: "{{ iscsi_base_wwn }}:{{ target.name }}"
    initiator_wwn: "{{ initiator }}"
  with_items:
    - "{{ target.initiators }}"
  loop_control:
    loop_var: "initiator"
  notify:
    - save targetcli configuration

- name: define backstore objects for target {{ target.name }}
  targetcli_backstore:
    backstore_type: "{{ disk.type }}"
    backstore_name: "{{ disk.name }}"
    options: " {{ iscsi_disk_path_prefix | default('') }}{{ disk.path }} "
  with_items:
    - "{{ target.disks }}"
  loop_control:
    loop_var: "disk"
  notify:
    - save targetcli configuration

- name: create portal for target {{ target.name }}
  targetcli_iscsi_portal:
    wwn: "{{ iscsi_base_wwn }}:{{ target.name }}"
    ip: "{{ iscsi_portal_ip }}"
    port: "{{ iscsi_portal_port | default(omit) }}"
  notify:
    - save targetcli configuration

- name: assign LUNs to initiators for target {{ target.name }}
  targetcli_iscsi_lun: 
    wwn: "{{ iscsi_base_wwn }}:{{ target.name }}"
    backstore_type: "{{ disk.type }}"
    backstore_name: "{{ disk.name }}"
  with_items:
    - "{{ target.disks }}"
  loop_control:
    loop_var: "disk"
  notify:
    - save targetcli configuration